name: Ubuntu builds
on: push
env:
  MAX_WARNINGS_GCC_6_Debug:     334
  MAX_WARNINGS_GCC_6_Release:   703
  MAX_WARNINGS_GCC_7_Debug:     336
  MAX_WARNINGS_GCC_7_Release:   371
  MAX_WARNINGS_GCC_8_Debug:     336
  MAX_WARNINGS_GCC_8_Release:   372
  MAX_WARNINGS_GCC_9_Debug:     359
  MAX_WARNINGS_GCC_9_Release:   400
  MAX_WARNINGS_Clang_7_Debug:   220
  MAX_WARNINGS_Clang_7_Release: 220
  MAX_WARNINGS_Clang_8_Debug:   220
  MAX_WARNINGS_Clang_8_Release: 220

jobs:

  build_matrix:
    name: ${{ matrix.compiler }}-${{ matrix.compiler_version }} (${{ matrix.build_type }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [Clang, GCC]
        compiler_version: [6, 7, 8, 9]
        build_type: [Debug, Release]
        exclude:
          - compiler: Clang
            compiler_version: 6
          - compiler: Clang
            compiler_version: 9
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - run:  sudo apt-get update
      - name: Install dependencies
        run:  sudo apt-get install -y $(./scripts/list-build-dependencies.sh -p apt --compiler ${{ matrix.compiler }} --compiler-version ${{ matrix.compiler_version }})
      - name: Build
        run:  ./scripts/build.sh --compiler ${{ matrix.compiler }} --compiler-version ${{ matrix.compiler_version }} --build-type ${{ matrix.build_type }}
      - name: Summarize warnings
        run:  ./scripts/count-warnings.py $MAX_WARNINGS_${{ matrix.compiler }}_${{ matrix.compiler_version }}_${{ matrix.build_type }} build.log
