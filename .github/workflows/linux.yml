name: Ubuntu builds
on: push
jobs:

  build_clang_8:
    name: clang-8 (release)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - run:  sudo apt-get update
      - name: Install dependencies
        run:  sudo apt-get install -y $(./scripts/list-build-dependencies.sh -p apt --compiler clang --compiler-version 8)
      - name: Build
        run:  ./scripts/build.sh --compiler clang --compiler-version 8 --lto
      - name: Summarize warnings
        run:  ./scripts/count-warnings.py 220 build.log

  build_gcc_9:
    name: gcc-9 (release)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - run:  sudo apt-get update
      - name: Install dependencies
        run:  sudo apt-get install -y $(./scripts/list-build-dependencies.sh -p apt --compiler-version 9)
      - name: Build
        run:  ./scripts/build.sh --compiler-version 9 --lto
      - name: Summarize warnings
        run:  ./scripts/count-warnings.py 376 build.log

  build_gcc_matrix:
    name: gcc (${{ matrix.build_type }}, ${{ matrix.os_version_major }}.04)
    runs-on: ubuntu-${{ matrix.os_version_major }}.04
    strategy:
      matrix:
        os_version_major: [16, 18]
        build_type:       [debug, release]
    env:
      max_warnings_ubuntu_16_gcc_debug:   329
      max_warnings_ubuntu_18_gcc_debug:   336
      max_warnings_ubuntu_16_gcc_release: 404
      max_warnings_ubuntu_18_gcc_release: 385
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - run:  sudo apt-get update
      - name: Install dependencies
        run:  sudo apt-get install -y $(./scripts/list-build-dependencies.sh -p apt)
      - name: Build
        run: ./scripts/build.sh --build-type ${{ matrix.build_type}}
      - name: Summarize warnings
        run:  ./scripts/count-warnings.py $max_warnings_ubuntu_${{ matrix.os_version_major }}_gcc_${{ matrix.build_type }} build.log

