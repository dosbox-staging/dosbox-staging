name: macOS builds
on: push
jobs:

  build_macos_clang_xcode:
    name: Clang (release, Xcode)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - name: Install dependencies
        run:  brew install $(./scripts/list-build-dependencies.sh -p brew --compiler clang)
      - name: Build
        run:  ./scripts/build.sh --compiler clang --lto
      - name: Summarize warnings
        run:  python3 ./scripts/count-warnings.py 272 build.log

  build_macos_gcc_brew:
    name: GCC-${{ matrix.compiler_version }} (release, Brew)
    runs-on: macos-latest
    strategy:
      matrix:
        compiler_version: [9]
        # gcc 6, 7, 8 builds fail under Darwin 19 due to broken Apple SDK headers
    env:
      max_warnings_gcc_9: 363
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - name: Install dependencies
        run:  brew install $(./scripts/list-build-dependencies.sh -p brew --compiler-version ${{ matrix.compiler_version }})
      - name: Build
        run:  ./scripts/build.sh --compiler-version ${{ matrix.compiler_version }} --lto
      - name: Summarize warnings
        run:  python3 ./scripts/count-warnings.py $max_warnings_gcc_${{ matrix.compiler_version }} build.log

  build_macos_gcc_macports:
    name: GCC-${{ matrix.compiler_version }} (release, MacPorts)
    runs-on: macos-latest
    strategy:
      matrix:
        compiler_version: [9]
        # MacPorts gcc 5, 6, 7, 8 fail under Darwin 19 due to install issues https://gcc.gnu.org/bugzilla/show_bug.cgi?id=90835
    env:
      max_warnings_gcc_9: 363
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - name: Install MacPorts
        run: |
          git clone --quiet --depth=1 https://github.com/macports/macports-base.git
          cd macports-base
          ./configure
          make -j"$(sysctl -n hw.physicalcpu || echo 4)"
          sudo make install

      - name: Install dependencies
        run: |
          PATH="/opt/local/sbin:/opt/local/bin:${PATH}"
          sudo port -q selfupdate || true
          sudo port -q install $(./scripts/list-build-dependencies.sh -p macports --compiler-version ${{ matrix.compiler_version }})

      - name: Build
        run:  ./scripts/build.sh --compiler-version mp-${{ matrix.compiler_version }} --bin-path /opt/local/bin
      - name: Summarize warnings
        run:  python3 ./scripts/count-warnings.py $max_warnings_gcc_${{ matrix.compiler_version }} build.log

