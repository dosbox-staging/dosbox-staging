name: macOS builds
on: push
env:
  MAX_WARNINGS_GCC_9_Debug:      -1
  MAX_WARNINGS_GCC_9_Release:   363
  MAX_WARNINGS_Clang_8_Debug:   272
  MAX_WARNINGS_Clang_8_Release: 272

jobs:

  build_macos_clang_xcode_matrix:
    name: Clang (${{ matrix.build_type }}, Xcode)
    runs-on: macos-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - name: Install dependencies
        run:  brew install $(./scripts/list-build-dependencies.sh -p brew --compiler clang)
      - name: Build
        run:  ./scripts/build.sh --compiler clang --build-type ${{ matrix.build_type }}
      - name: Summarize warnings
        run:  python3 ./scripts/count-warnings.py $MAX_WARNINGS_Clang_8_${{ matrix.build_type }} build.log

  build_macos_gcc_matrix:
    name: GCC-${{ matrix.compiler_version }} (${{ matrix.build_type }}, ${{ matrix.package_manager }})
    runs-on: macos-latest
    strategy:
      matrix:
        compiler_version: [9]
        package_manager:  [Brew, MacPorts]
        build_type:       [Debug, Release]
    steps:
      - uses: actions/checkout@v1
      - name: Log environment
        run:  ./scripts/log-env.sh
      - name: Install ${{ matrix.package_manager }}
        if: matrix.package_manager == 'MacPorts'
        run: |
          git clone --quiet --depth=1 https://github.com/macports/macports-base.git
          (cd macports-base
          ./configure
          make -j"$(sysctl -n hw.physicalcpu || echo 4)"
          sudo make install)
          sudo /opt/local/bin/port -q selfupdate || true
      - name: Install dependencies using ${{ matrix.package_manager }}
        run: >
          eval $([[ "${{ matrix.package_manager }}" == "Brew" ]]
          && echo brew
          || echo sudo /opt/local/bin/port -q) install
          $(./scripts/list-build-dependencies.sh -p ${{ matrix.package_manager }} --compiler-version ${{ matrix.compiler_version }})
      - name: Build
        run: |
          PATH="/opt/local/sbin:/opt/local/bin:${PATH}"
          ./scripts/build.sh --compiler-version ${{ matrix.compiler_version }} --build-type ${{ matrix.build_type }}
      - name: Summarize warnings
        run:  python3 ./scripts/count-warnings.py $MAX_WARNINGS_GCC_${{ matrix.compiler_version }}_${{ matrix.build_type }} build.log
