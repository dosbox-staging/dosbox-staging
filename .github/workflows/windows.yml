name: Windows builds
on: push

jobs:

  build_windows_msys2:
    name: ${{ matrix.conf.compiler }} ${{ matrix.conf.bits }}-bit
    runs-on: windows-latest
    strategy:
      matrix:
        conf:
          - compiler: GCC
            bits: 32
            arch: i686
            max_warnings: 229
          - compiler: GCC
            bits: 64
            arch: x86_64
            max_warnings: 304
          - compiler: Clang
            bits: 32
            arch: i686
            max_warnings: 98
          - compiler: Clang
            bits: 64
            arch: x86_64
            max_warnings: 142
    env:
      CHERE_INVOKING: yes
    steps:
      - uses:  actions/checkout@v1
      - uses:  actions/cache@v1
        id:    cache-msys2
        if:    matrix.conf.compiler == 'GCC'
        with:
          path: 'C:/tools/msys64'
          key: msys2-${{ matrix.conf.compiler }}-${{ matrix.conf.bits }}-2019-v11}
      - name:  Install MSYS2
        if:    steps.cache-msys2.outputs.cache-hit != 'true'
        run:   choco install msys2 --no-progress
      - name:  Install C++ compiler and libraries
        if:    steps.cache-msys2.outputs.cache-hit != 'true'
        shell: python scripts\msys-bash.py {0}
        run:   ./scripts/list-build-dependencies.sh -m msys2 -c ${{ matrix.conf.compiler }} -b ${{ matrix.conf.bits }} | xargs pacman -S --noconfirm
      - name:  Shrink MSYS2 for cache
        if:    matrix.conf.compiler == 'GCC' && steps.cache-msys2.outputs.cache-hit != 'true'
        shell: python scripts\msys-bash.py {0}
        run:   ./.github/scripts/shrink-msys2.sh
      - name:  Log environment
        shell: python scripts\msys-bash.py {0}
        run:   ./scripts/log-env.sh
      - name:  Build
        shell: python scripts\msys-bash.py {0}
        run: |
          # export these two in script to override variables defined by MSYS2 
          export MSYSTEM_CARCH=${{ matrix.conf.arch }}
          export MSYSTEM_CHOST=${{ matrix.conf.arch }}-pc-msys
          ./scripts/build.sh --compiler ${{ matrix.conf.compiler }} --build-type Debug --bin-path /mingw${{ matrix.conf.bits }}/bin
      - name:  Summarize warnings
        env:
          MAX_WARNINGS: ${{ matrix.conf.max_warnings }}
        run:   python scripts\count-warnings.py build.log

  build_msvc_matrix:
    name: MSVC 32-bit (${{ matrix.type }})
    runs-on: windows-latest
    strategy:
      matrix:
        type: [Release, Debug]
    steps:
      - uses:  actions/checkout@v1
      - name:  Install packages
        shell: pwsh
        run: |
          vcpkg install libpng sdl1 sdl1-net opusfile
          vcpkg integrate install
      - name:  Log environment
        shell: pwsh
        run:   .\scripts\log-env.ps1
      - name:  ${{ matrix.type }} build
        shell: pwsh
        env:
          PATH: '${env:PATH};C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\amd64'
        run: |
          cd vs
          MSBuild -m dosbox.sln -p:Configuration=${{ matrix.type }}
