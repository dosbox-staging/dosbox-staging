name: Windows builds
on: push
env:
  MAX_WARNINGS_GCC_32bit_Debug:      29
  MAX_WARNINGS_GCC_64bit_Debug:      48
  MAX_WARNINGS_GCC_32bit_Release:    42
  MAX_WARNINGS_GCC_64bit_Release:    61
  MAX_WARNINGS_Clang_32bit_Debug:   119
  MAX_WARNINGS_Clang_64bit_Debug:   199
  MAX_WARNINGS_Clang_32bit_Release: 119
  MAX_WARNINGS_Clang_64bit_Release: 199

jobs:

  build_msvc_matrix:
    name: MSVC 32-bit (${{ matrix.build_type }})
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    steps:
      - uses:  actions/checkout@v1
      - name:  Log environment
        shell: pwsh
        run:   .\scripts\log-env.ps1
      - name:  Install packages
        shell: pwsh
        run: |
          vcpkg install libpng sdl1 sdl1-net opusfile
          vcpkg integrate install
      - name:  Build
        shell: pwsh
        env:
          PATH: '${env:PATH};C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\amd64'
        run: |
          # build steps
          cd visualc_net
          MSBuild -m dosbox.sln -p:Configuration=${{ matrix.build_type }}

  build_msys2_matrix:
    name: ${{ matrix.compiler }} ${{ matrix.bits }}-bit (${{ matrix.build_type }})
    runs-on: windows-latest
    strategy:
      matrix:
        compiler:   [GCC, Clang]
        bits:       [32, 64]
        build_type: [Debug, Release]
    env:
      CHERE_INVOKING: yes
    steps:
      - uses:  actions/checkout@v1
      - name:  Install msys2 environment
        run:   choco install msys2 --no-progress
      - name:  Log environment
        shell: python scripts\msys-bash.py {0}
        run:   ./scripts/log-env.sh
      - name:  Install dependencies
        shell: python scripts\msys-bash.py {0}
        run:   ./scripts/list-build-dependencies.sh -p msys2 --compiler ${{ matrix.compiler }} --bit-depth ${{ matrix.bits }} | xargs pacman -S --noconfirm
      - name:  Build
        shell: python scripts\msys-bash.py {0}
        run:   ./scripts/build.sh --compiler ${{ matrix.compiler }} --bit-depth ${{ matrix.bits }} --build-type ${{ matrix.build_type }} --bin-path /mingw${{ matrix.bits }}/bin
      - name:  Summarize warnings
        run:   .\scripts\count-warnings.py $env:MAX_WARNINGS_${{ matrix.compiler }}_${{ matrix.bits }}bit_${{ matrix.build_type }} build.log

